<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:16px;background:#fafafa;line-height:1.5}
  h1{font-size:18px;margin:0 0 10px}
  .card{background:#fff;border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{padding:10px 12px;border-radius:12px;border:1px solid #bbb;background:#fff}
  button.primary{border-color:#111}
  button:disabled{opacity:.45}
  input,textarea{width:100%;box-sizing:border-box;padding:10px;border-radius:12px;border:1px solid #bbb}
  .pill{padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#bbb;display:inline-block}
  .dot.rec{background:#d00000;box-shadow:0 0 0 4px rgba(208,0,0,.15)}
  .small{font-size:13px;color:#555}
  .historyItem{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
</style>
</head>
<body>

<h1>è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>

<div class="card">
  <div class="row">
    <span class="pill">ãŠé¡Œ</span>
    <span id="tag" class="pill">æœªé¸æŠ</span>
    <button id="nextPromptBtn">ãŠé¡Œã‚’å‡ºã™</button>
  </div>
  <p id="prompt" style="font-weight:600;">ã€ŒãŠé¡Œã‚’å‡ºã™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
</div>

<div class="card">
  <div class="small">ä¸€è¨€è¦ç´„ï¼ˆ30æ–‡å­—ç›®å®‰ï¼‰</div>
  <input id="oneLine" placeholder="ä¾‹ï¼šãƒ•ãƒ­ã‚¹ã¯éš£æ¥é¢ã®æ±šã‚Œã‚’è½ã¨ã™ãŸã‚å¿…è¦">
  <div class="small" style="margin-top:10px;">çµè«–â†’ç†ç”±â†’ä¾‹ï¼ˆç®‡æ¡æ›¸ãã§OKï¼‰</div>
  <input id="ketsuron" placeholder="çµè«–">
  <input id="riyuu" placeholder="ç†ç”±" style="margin-top:8px;">
  <input id="rei" placeholder="ä¾‹" style="margin-top:8px;">
</div>

<div class="card">
  <div class="row">
    <span class="pill">éŒ²éŸ³</span>
    <span id="recDot" class="dot"></span>
    <span id="recStatus" class="small">éŒ²éŸ³ãªã—</span>
  </div>
  <div class="row" style="margin-top:8px;">
    <button class="primary" id="recStartBtn">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
    <button id="recStopBtn" disabled>â¹ éŒ²éŸ³åœæ­¢</button>
    <button id="recClearBtn" disabled>ğŸ—‘ ç ´æ£„</button>
  </div>
  <audio id="recPreview" controls style="width:100%;margin-top:10px;display:none;"></audio>
</div>

<div class="card">
  <div class="row">
    <button class="primary" id="saveBtn">è¨˜éŒ²ã‚’ä¿å­˜</button>
    <button id="copyBtn">æ·»å‰Šç”¨ã«ã‚³ãƒ”ãƒ¼</button>
    <button id="wipeBtn">å±¥æ­´å‰Šé™¤</button>
  </div>
  <div id="history" class="small" style="margin-top:10px;"></div>
</div>

<script>
const $ = id => document.getElementById(id);

// ===== Prompts (random, no immediate repeat) =====
const prompts = [
  { tag:"æ­¯ç§‘ï¼ˆæ‚£è€…èª¬æ˜ï¼‰", text:"ãƒ•ãƒ­ã‚¹ãŒå¿…è¦ãªç†ç”±ã‚’ã€æ‚£è€…ã•ã‚“ã«ã‚ã‹ã‚‹è¨€è‘‰ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"æ­¯ç§‘ï¼ˆåˆè¨ºï¼‰", text:"ã€åˆè¨ºã§ã¯ä»Šæ—¥ã¯æ²»ç™‚ã‚’ã—ãªã„ã€ç†ç”±ã‚’ã€å®‰å¿ƒæ„ŸãŒå‡ºã‚‹ã‚ˆã†ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘", text:"é™¢å†…ã§ã€çµè«–ã‹ã‚‰è©±ã™ã€ãƒ«ãƒ¼ãƒ«ã‚’å°å…¥ã™ã‚‹ç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"çµŒå–¶", text:"æ¤œæŸ»ï¼ˆå†™çœŸãƒ»æ­¯å‘¨æ¤œæŸ»ç­‰ï¼‰ã‚’å¤§äº‹ã«ã™ã‚‹ä¾¡å€¤ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"æ—¥å¸¸", text:"ä»Šæ—¥ã„ã¡ã°ã‚“å¤§äº‹ã ã£ãŸå‡ºæ¥äº‹ã‚’ã€ç«¯çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" }
];
let promptIndex = -1;

function pickRandomPromptIndex(){
  if (prompts.length <= 1) return 0;
  let idx = promptIndex;
  while(idx === promptIndex) idx = Math.floor(Math.random() * prompts.length);
  return idx;
}
function nextPrompt(){
  promptIndex = pickRandomPromptIndex();
  $("tag").textContent = prompts[promptIndex].tag;
  $("prompt").textContent = prompts[promptIndex].text;
}
$("nextPromptBtn").addEventListener("click", nextPrompt);

// ===== IndexedDB for audio =====
const DB_NAME = "talk_trainer_db_v1";
const STORE = "audio";
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function putBlob(key, blob){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).put(blob, key);
    tx.oncomplete=()=>{db.close();resolve();};
    tx.onerror=()=>{db.close();reject(tx.error);};
  });
}
async function getBlob(key){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE,"readonly");
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess=()=>{const v=req.result;db.close();resolve(v||null);};
    req.onerror=()=>{db.close();reject(req.error);};
  });
}
async function delBlob(key){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).delete(key);
    tx.oncomplete=()=>{db.close();resolve();};
    tx.onerror=()=>{db.close();reject(tx.error);};
  });
}

// ===== Recording =====
let mediaStream=null, recorder=null, chunks=[], previewUrl=null;
let audioKey=null;

function setRecUI(isRec){
  $("recDot").className = "dot" + (isRec ? " rec" : "");
  $("recStartBtn").disabled = isRec;
  $("recStopBtn").disabled = !isRec;
  $("recClearBtn").disabled = isRec ? true : !audioKey;
  $("recStatus").textContent = isRec ? "éŒ²éŸ³ä¸­â€¦" : (audioKey ? "éŒ²éŸ³ã‚ã‚Šï¼ˆä¿å­˜æ¸ˆã¿ï¼‰" : "éŒ²éŸ³ãªã—");
}

async function startRecording(){
  try{
    if (!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks=[];
    recorder = new MediaRecorder(mediaStream);
    recorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
    recorder.onstop = async () => {
      const blob = new Blob(chunks, {type: recorder.mimeType || "audio/webm"});
      audioKey = "audio_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      await putBlob(audioKey, blob);

      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(blob);
      $("recPreview").src = previewUrl;
      $("recPreview").style.display="block";

      setRecUI(false);
      renderHistory();
    };
    recorder.start();
    setRecUI(true);
  }catch(err){
    alert("ãƒã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    console.error(err);
  }
}
function stopRecording(){ if (recorder && recorder.state!=="inactive") recorder.stop(); }
async function clearRecording(){
  if (!audioKey) return;
  await delBlob(audioKey);
  audioKey=null;
  if (previewUrl) URL.revokeObjectURL(previewUrl);
  previewUrl=null;
  $("recPreview").removeAttribute("src");
  $("recPreview").style.display="none";
  setRecUI(false);
  renderHistory();
}

$("recStartBtn").addEventListener("click", startRecording);
$("recStopBtn").addEventListener("click", stopRecording);
$("recClearBtn").addEventListener("click", clearRecording);

// ===== History (localStorage) =====
const KEY="talk_trainer_history_v3";
function getHistory(){
  try{return JSON.parse(localStorage.getItem(KEY)||"[]");}catch{return [];}
}
function setHistory(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
async function playAudio(k, btn){
  try{
    btn.disabled=true;
    const blob=await getBlob(k);
    if(!blob){alert("éŒ²éŸ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return;}
    const url=URL.createObjectURL(blob);
    const a=new Audio(url);
    a.onended=()=>URL.revokeObjectURL(url);
    await a.play();
  }finally{
    btn.disabled=false;
  }
}
function renderHistory(){
  const h=getHistory().slice(0,10);
  const root=$("history");
  root.innerHTML="";
  if(h.length===0){ root.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }

  h.forEach(item=>{
    const d=new Date(item.date);
    const div=document.createElement("div");
    div.className="historyItem";
    div.innerHTML = `
      <div class="row">
        <span class="pill">${escapeHtml(d.toLocaleString("ja-JP"))}</span>
        <span class="pill">${escapeHtml(item.tag||"-")}</span>
        ${item.audioKey ? `<button data-a="${escapeHtml(item.audioKey)}">â–¶ å†ç”Ÿ</button>` : `<span class="small">éŒ²éŸ³ãªã—</span>`}
      </div>
      <div><b>ä¸€è¨€ï¼š</b>${escapeHtml(item.oneLine||"")}</div>
      <div class="small">${escapeHtml(item.prompt||"")}</div>
    `;
    root.appendChild(div);
    const btn=div.querySelector("button[data-a]");
    if(btn) btn.addEventListener("click", ()=>playAudio(btn.getAttribute("data-a"), btn));
  });
}

function buildRecord(){
  const p=(promptIndex===-1)?{tag:"",text:""}:prompts[promptIndex];
  return {
    date: new Date().toISOString(),
    tag: p.tag,
    prompt: p.text,
    oneLine: $("oneLine").value.trim(),
    ketsuron: $("ketsuron").value.trim(),
    riyuu: $("riyuu").value.trim(),
    rei: $("rei").value.trim(),
    audioKey: audioKey || null
  };
}

$("saveBtn").addEventListener("click", ()=>{
  if(promptIndex===-1) nextPrompt();
  const rec=buildRecord();
  const h=getHistory();
  h.unshift(rec);
  setHistory(h);
  renderHistory();
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
});

$("copyBtn").addEventListener("click", async ()=>{
  const rec=buildRecord();
  const text =
`ã€è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã€‘
ãŠé¡Œï¼š${rec.tag} / ${rec.prompt}

ä¸€è¨€ï¼š${rec.oneLine}

çµè«–ï¼š${rec.ketsuron}
ç†ç”±ï¼š${rec.riyuu}
ä¾‹ï¼š${rec.rei}

éŒ²éŸ³ï¼š${rec.audioKey ? "ã‚ã‚Šï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰" : "ãªã—"}
`;
  try{
    await navigator.clipboard.writeText(text);
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ã“ã“ã«è²¼ã‚Œã°æ·»å‰Šã§ãã¾ã™ã€‚");
  }catch{
    alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
});

$("wipeBtn").addEventListener("click", ()=>{
  if(!confirm("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  setHistory([]);
  renderHistory();
});

setRecUI(false);
renderHistory();
</script>
</body>
</html>
