// ==== DEBUG PANEL (ã‚¹ãƒãƒ›ç”¨) ====
(() => {
  const box = document.createElement("div");
  box.style.cssText =
    "position:fixed;left:10px;right:10px;bottom:10px;max-height:40vh;overflow:auto;" +
    "background:#fff;border:2px solid #d00;border-radius:12px;padding:10px;z-index:99999;" +
    "font-size:12px;white-space:pre-wrap;display:none";
  const show = (m) => { box.style.display="block"; box.textContent += m + "\n"; };
  window.addEventListener("error", (e) => show("JS ERROR: " + (e.message || e.error)));
  window.addEventListener("unhandledrejection", (e) => show("PROMISE: " + (e.reason?.message || e.reason)));
  document.addEventListener("DOMContentLoaded", () => document.body.appendChild(box));
})();

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest">
  <title>è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; line-height: 1.5; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { border-color:#111; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    input, textarea, select { width:100%; box-sizing:border-box; padding:10px; border-radius:12px; border:1px solid #bbb; }
    .pill { padding:4px 10px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .ok { border-color:#1a7f37; color:#1a7f37; }
    .warn { border-color:#b45309; color:#b45309; }
    .timer { font-size: 40px; font-variant-numeric: tabular-nums; margin: 6px 0; }
    .small { color:#444; font-size: 13px; }
    .steps { display:grid; gap:10px; }
    .stepTitle { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .muted { color:#666; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .historyItem { border-top:1px solid #eee; padding-top:10px; margin-top:10px; }
    .mono { font-variant-numeric: tabular-nums; }
    .dot { width:10px; height:10px; border-radius:999px; background:#bbb; display:inline-block; }
    .dot.rec { background:#d00000; box-shadow: 0 0 0 4px rgba(208,0,0,.15); }
    .audioBox { padding:10px; border:1px solid #eee; border-radius:12px; margin-top:10px; }
  </style>
</head>
<body>
  <h1>è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆé †ç•ªï¼šä¸€è¨€â†’æ§‹é€ â†’30ç§’â†’15ç§’ï¼‰</h1>

  <div class="card">
    <div class="row">
      <span class="pill">ãŠé¡Œ</span>
      <span id="tag" class="pill ok">æœªé¸æŠ</span>
      <button id="nextPromptBtn">ãŠé¡Œã‚’å‡ºã™</button>
    </div>
    <div style="margin-top:10px;">
      <div class="small muted">ä»Šæ—¥ã®ãŠé¡Œ</div>
      <div id="prompt" style="font-size:16px; font-weight:600;">ã€ŒãŠé¡Œã‚’å‡ºã™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    </div>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <b>STEP 1ï¼šä¸€è¨€è¦ç´„ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰</b>
        <div class="small">ä¸»èªï¼‹çµè«–ã€‚ã¾ãšâ€œè¨€ã„åˆ‡ã‚‹â€ã€‚</div>
      </div>
      <span id="s1Badge" class="pill warn">æœªå®Œäº†</span>
    </div>
    <input id="oneLine" placeholder="ä¾‹ï¼šãƒ•ãƒ­ã‚¹ã¯æ­¯ãƒ–ãƒ©ã‚·ã§å±Šã‹ãªã„æ±šã‚Œã‚’è½ã¨ã™ãŸã‚å¿…è¦" maxlength="60">
    <div class="row" style="margin-top:10px;">
      <button class="primary" id="s1DoneBtn">STEP1å®Œäº†</button>
      <span class="small muted">ï¼ˆç›®å®‰ï¼š30æ–‡å­—ã€‚å¤šå°‘ã‚ªãƒ¼ãƒãƒ¼ã¯OKï¼‰</span>
    </div>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <b>STEP 2ï¼šçµè«–â†’ç†ç”±â†’ä¾‹ï¼ˆç®‡æ¡æ›¸ãã§OKï¼‰</b>
        <div class="small">è©±ã™å‰ã«â€œå‹â€ã‚’ç½®ãã€‚ã“ã“ãŒæœ€é‡è¦ã€‚</div>
      </div>
      <span id="s2Badge" class="pill warn">ãƒ­ãƒƒã‚¯ä¸­</span>
    </div>

    <div class="steps">
      <div>
        <div class="small muted">çµè«–ï¼ˆ1æ–‡ï¼‰</div>
        <input id="ketsuron" placeholder="ä¾‹ï¼šãƒ•ãƒ­ã‚¹ã¯æ¯æ—¥å¿…è¦ã§ã™" disabled>
      </div>
      <div>
        <div class="small muted">ç†ç”±ï¼ˆ1ã¤ã§OKï¼‰</div>
        <input id="riyuu" placeholder="ä¾‹ï¼šæ­¯ãƒ–ãƒ©ã‚·ã§ã¯éš£æ¥é¢ã®æ±šã‚ŒãŒæ®‹ã‚‹ã‹ã‚‰" disabled>
      </div>
      <div>
        <div class="small muted">å…·ä½“ä¾‹ï¼ˆ1ã¤ã§OKï¼‰</div>
        <input id="rei" placeholder="ä¾‹ï¼šéš£æ¥é¢ã®è™«æ­¯ã‚„æ­¯è‚‰ç‚ã¯ãã“ã‹ã‚‰èµ·ãã‚„ã™ã„" disabled>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="s2DoneBtn" disabled>STEP2å®Œäº†</button>
    </div>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <b>STEP 3ï¼š30ç§’ã§è©±ã™ï¼ˆã‚¿ã‚¤ãƒãƒ¼ï¼‰ï¼‹éŒ²éŸ³</b>
        <div class="small">çµè«–â†’ç†ç”±â†’ä¾‹ã§ã€‚éŒ²éŸ³ã—ãŸã‚‰å±¥æ­´ã‹ã‚‰å†ç”Ÿã§ãã¾ã™ã€‚</div>
      </div>
      <span id="s3Badge" class="pill warn">ãƒ­ãƒƒã‚¯ä¸­</span>
    </div>

    <div class="row">
      <span class="pill">ãƒ“ãƒ¼ãƒ—</span>
      <select id="beep" disabled>
        <option value="on">ON</option>
        <option value="off">OFF</option>
      </select>
    </div>

    <div class="timer mono" id="timer">00:00.0</div>

    <div class="row">
      <button class="primary" id="startBtn" disabled>START</button>
      <button id="stopBtn" disabled>STOP</button>
      <button id="resetBtn" disabled>RESET</button>
      <button id="s3DoneBtn" disabled>STEP3å®Œäº†</button>
    </div>

    <div class="audioBox">
      <div class="row">
        <span class="pill">éŒ²éŸ³</span>
        <span id="recDot" class="dot"></span>
        <span id="recStatus" class="small muted">STEP2å®Œäº†å¾Œã«ä½¿ãˆã¾ã™ã€‚</span>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="primary" id="recStartBtn" disabled>ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
        <button id="recStopBtn" disabled>â¹ éŒ²éŸ³åœæ­¢</button>
        <button id="recClearBtn" disabled>ğŸ—‘ éŒ²éŸ³ã‚’ç ´æ£„</button>
      </div>
      <audio id="recPreview" controls style="width:100%; margin-top:10px; display:none;"></audio>
      <div class="small muted" style="margin-top:8px;">
        â€»åˆå›ã¯ãƒã‚¤ã‚¯è¨±å¯ãŒå‡ºã¾ã™ã€‚ã€Œè¨±å¯ã€ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <div class="small" id="status">STEP2å®Œäº†å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚</div>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <b>STEP 4ï¼š15ç§’ã«å‰Šã‚‹ï¼ˆåŒã˜å†…å®¹ï¼‰</b>
        <div class="small">â€œåŠåˆ†ã«ã™ã‚‹â€ãŒç«¯çš„åŒ–ã®æ ¸å¿ƒã€‚</div>
      </div>
      <span id="s4Badge" class="pill warn">ãƒ­ãƒƒã‚¯ä¸­</span>
    </div>

    <div class="row">
      <button class="primary" id="start15Btn" disabled>15ç§’START</button>
      <button id="s4DoneBtn" disabled>STEP4å®Œäº†</button>
    </div>
    <div class="small muted" style="margin-top:8px;">
      â€»STEP3ã‚’çµ‚ãˆãŸã‚‰ã€åŒã˜å†…å®¹ã‚’15ç§’ã§ã€‚
    </div>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <b>è©•ä¾¡ï¼ˆæ‰‹å‹•ï¼‰</b>
        <div class="small">æ¬¡ã¯è‡ªå‹•è©•ä¾¡ã¸ï¼ˆå¾Œã§è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚</div>
      </div>
      <span id="evalBadge" class="pill warn">æœªä¿å­˜</span>
    </div>

    <div class="row">
      <label class="pill"><input type="checkbox" id="chkConclusion"> çµè«–ãŒæœ€åˆ</label>
      <label class="pill"><input type="checkbox" id="chkReason"> ç†ç”±ãŒæ˜ç¢º</label>
      <label class="pill"><input type="checkbox" id="chkExample"> ä¾‹ãŒå…·ä½“</label>
      <label class="pill"><input type="checkbox" id="chkNoFiller"> ãƒ•ã‚£ãƒ©ãƒ¼å°‘ãªã„</label>
      <label class="pill"><input type="checkbox" id="chkNoRepeat"> é‡è¤‡å°‘ãªã„</label>
    </div>

    <div class="hr"></div>

    <div class="small muted">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
    <textarea id="memo" rows="4" placeholder="æ”¹å–„ç‚¹ï¼šçµè«–ãŒé…ã„ï¼ç†ç”±ãŒ2ã¤ã«ãªã£ãŸï¼ä¾‹ãŒå¼±ã„ ãªã©"></textarea>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="saveBtn" disabled>ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
      <button id="copyBtn" disabled>æ·»å‰Šç”¨ã«ã‚³ãƒ”ãƒ¼</button>
      <button id="clearBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="small muted">ä¿å­˜ã™ã‚‹ã¨å±¥æ­´ã«æ®‹ã‚Šã¾ã™ï¼ˆç«¯æœ«å†…ï¼‰ã€‚éŒ²éŸ³ã‚‚ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <b>å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</b>
        <div class="small">éŒ²éŸ³ãŒã‚ã‚‹è¨˜éŒ²ã¯ã€Œå†ç”Ÿã€ã§ãã¾ã™ã€‚</div>
      </div>
      <button id="wipeHistoryBtn">å±¥æ­´å‰Šé™¤</button>
    </div>
    <div id="history"></div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ---- IndexedDB (audio) ----
  const DB_NAME = "talk_trainer_db_v1";
  const STORE = "audio";
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function putBlob(key, blob) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put(blob, key);
      tx.oncomplete = () => { db.close(); resolve(); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }
  async function getBlob(key) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).get(key);
      req.onsuccess = () => { const v = req.result; db.close(); resolve(v || null); };
      req.onerror = () => { db.close(); reject(req.error); };
    });
  }
  async function delBlob(key) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).delete(key);
      tx.oncomplete = () => { db.close(); resolve(); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }

  // ---- Prompts ----
  const prompts = [
    { tag: "æ­¯ç§‘ï¼ˆæ‚£è€…èª¬æ˜ï¼‰", text: "ãƒ•ãƒ­ã‚¹ãŒå¿…è¦ãªç†ç”±ã‚’ã€æ‚£è€…ã•ã‚“ã«ã‚ã‹ã‚‹è¨€è‘‰ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
    { tag: "æ­¯ç§‘ï¼ˆåˆè¨ºï¼‰", text: "ã€åˆè¨ºã§ã¯ä»Šæ—¥ã¯æ²»ç™‚ã‚’ã—ãªã„ã€ç†ç”±ã‚’ã€å®‰å¿ƒæ„ŸãŒå‡ºã‚‹ã‚ˆã†ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
    { tag: "ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘", text: "é™¢å†…ã§ã€çµè«–ã‹ã‚‰è©±ã™ã€ãƒ«ãƒ¼ãƒ«ã‚’å°å…¥ã™ã‚‹ç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
    { tag: "çµŒå–¶", text: "æ¤œæŸ»ï¼ˆå†™çœŸãƒ»æ­¯å‘¨æ¤œæŸ»ç­‰ï¼‰ã‚’å¤§äº‹ã«ã™ã‚‹ä¾¡å€¤ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
    { tag: "æ—¥å¸¸", text: "ä»Šæ—¥ã„ã¡ã°ã‚“å¤§äº‹ã ã£ãŸå‡ºæ¥äº‹ã‚’ã€ç«¯çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
    { tag: "å­¦ä¼š/ç™ºè¡¨", text: "ã‚ãªãŸã®ãƒ†ãƒ¼ãƒã®è‡¨åºŠçš„æ„ç¾©ï¼ˆä¾¡å€¤ï¼‰ã‚’30ç§’ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" }
  ];
  let promptIndex = -1;

  function pickRandomPromptIndex() {
    if (prompts.length <= 1) return 0;
    let idx = promptIndex;
    while (idx === promptIndex) idx = Math.floor(Math.random() * prompts.length);
    return idx;
  }

  function nextPrompt() {
    promptIndex = pickRandomPromptIndex();
    $("tag").textContent = prompts[promptIndex].tag;
    $("prompt").textContent = prompts[promptIndex].text;
  }

  // ---- State / Locks ----
  const state = {
    s1:false, s2:false, s3:false, s4:false,
    last30ms:0, last15ms:0,
    audioKey: null
  };

  // ---- Timer ----
  let raf = null;
  let startAt = null;
  let elapsed = 0;
  let durationMs = 30000;

  function renderTime(ms) {
    const s = ms / 1000;
    const m = Math.floor(s / 60);
    const rem = (s - m * 60).toFixed(1).padStart(4,"0");
    $("timer").textContent = String(m).padStart(2,"0") + ":" + rem;
  }

  function beep() {
    if ($("beep").value !== "on") return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine"; o.frequency.value = 880;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(() => { o.stop(); ctx.close(); }, 180);
  }

  function loop() {
    const now = performance.now();
    elapsed = now - startAt;
    if (elapsed >= durationMs) {
      elapsed = durationMs;
      renderTime(elapsed);
      stopTimer(true);
      return;
    }
    renderTime(elapsed);
    raf = requestAnimationFrame(loop);
  }

  function startTimer(sec) {
    durationMs = sec * 1000;
    if (raf) cancelAnimationFrame(raf);
    startAt = performance.now() - elapsed;
    raf = requestAnimationFrame(loop);
    $("startBtn").disabled = true;
    $("stopBtn").disabled = false;
    $("status").textContent = (sec === 30) ? "30ç§’ï¼šè©±ã—ã¦ãã ã•ã„ã€‚" : "15ç§’ï¼šå‰Šã£ã¦è©±ã—ã¦ãã ã•ã„ã€‚";
  }

  function stopTimer(auto=false) {
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
    if (auto) { beep(); $("status").textContent = "æ™‚é–“ã§ã™ã€‚æ¬¡ã¯å‰Šã‚Šï¼ˆ15ç§’ï¼‰ã¸ã€‚"; }
    else { $("status").textContent = "åœæ­¢ã—ã¾ã—ãŸã€‚"; }
  }

  function resetTimer() {
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    elapsed = 0;
    renderTime(0);
    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
    $("status").textContent = "RESETã—ã¾ã—ãŸã€‚";
  }

  // ---- Recording ----
  let mediaStream = null;
  let recorder = null;
  let chunks = [];
  let previewUrl = null;

  function setRecUI(isRec) {
    $("recDot").className = "dot" + (isRec ? " rec" : "");
    $("recStartBtn").disabled = isRec;
    $("recStopBtn").disabled = !isRec;
    $("recClearBtn").disabled = isRec ? true : !state.audioKey;
    $("recStatus").textContent = isRec ? "éŒ²éŸ³ä¸­â€¦" : (state.audioKey ? "éŒ²éŸ³ã‚ã‚Šï¼ˆä¿å­˜æ¸ˆã¿ï¼‰" : "éŒ²éŸ³ãªã—");
  }

  async function startRecording() {
    try {
      if (!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];
      recorder = new MediaRecorder(mediaStream);
      recorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: recorder.mimeType || "audio/webm" });
        const key = "audio_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        await putBlob(key, blob);
        state.audioKey = key;

        if (previewUrl) URL.revokeObjectURL(previewUrl);
        previewUrl = URL.createObjectURL(blob);
        $("recPreview").src = previewUrl;
        $("recPreview").style.display = "block";
        setRecUI(false);
      };
      recorder.start();
      setRecUI(true);
    } catch (err) {
      alert("ãƒã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒã‚¤ã‚¯æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
      console.error(err);
    }
  }

  async function stopRecording() {
    if (recorder && recorder.state !== "inactive") recorder.stop();
  }

  async function clearRecording() {
    if (!state.audioKey) return;
    await delBlob(state.audioKey);
    state.audioKey = null;
    if (previewUrl) URL.revokeObjectURL(previewUrl);
    previewUrl = null;
    $("recPreview").removeAttribute("src");
    $("recPreview").style.display = "none";
    setRecUI(false);
  }

  // ---- Locks ----
  function unlockStep2() {
    ["ketsuron","riyuu","rei"].forEach(id => $(id).disabled = false);
    $("s2DoneBtn").disabled = false;
    $("s2Badge").textContent = "æœªå®Œäº†";
  }

  function unlockStep3() {
    $("beep").disabled = false;
    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
    $("resetBtn").disabled = false;
    $("s3DoneBtn").disabled = false;
    $("s3Badge").textContent = "æœªå®Œäº†";
    $("status").textContent = "30ç§’ã§è©±ã—ã¦ãã ã•ã„ï¼ˆçµè«–â†’ç†ç”±â†’ä¾‹ï¼‰ã€‚";
    $("recStartBtn").disabled = false;
    $("recStopBtn").disabled = true;
    $("recClearBtn").disabled = !state.audioKey;
    $("recStatus").textContent = "éŒ²éŸ³ã§ãã¾ã™ï¼ˆä»»æ„ï¼‰ã€‚";
  }

  function unlockStep4() {
    $("start15Btn").disabled = false;
    $("s4DoneBtn").disabled = false;
    $("s4Badge").textContent = "æœªå®Œäº†";
  }

  function unlockSave() {
    $("saveBtn").disabled = false;
    $("copyBtn").disabled = false;
    $("evalBadge").textContent = "ä¿å­˜ã§ãã¾ã™";
    $("evalBadge").className = "pill ok";
  }

  // ---- History (text) ----
  const KEY = "talk_trainer_history_v2";
  function getHistory() {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }
  function setHistory(list) { localStorage.setItem(KEY, JSON.stringify(list)); }

  function msToStr(ms) {
    const s = (ms/1000);
    return isFinite(s) ? s.toFixed(1) + "s" : "-";
  }
  function escapeHtml(s) {
    return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function playAudio(audioKey, btnEl) {
    try {
      btnEl.disabled = true;
      const blob = await getBlob(audioKey);
      if (!blob) { alert("éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆç«¯æœ«å†…ä¿å­˜ã§ã™ï¼‰ã€‚"); return; }
      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.onended = () => URL.revokeObjectURL(url);
      await a.play();
    } catch (e) {
      alert("å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      console.error(e);
    } finally {
      btnEl.disabled = false;
    }
  }

  function renderHistory() {
    const h = getHistory().slice(0,10);
    const root = $("history");
    root.innerHTML = "";
    if (h.length === 0) {
      root.innerHTML = `<div class="small muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }
    h.forEach(item => {
      const d = new Date(item.date);
      const ds = d.toLocaleString("ja-JP");
      const score = Object.values(item.checks || {}).filter(Boolean).length;

      const div = document.createElement("div");
      div.className = "historyItem";
      const audioBtn = item.audioKey
        ? `<button data-audio="${escapeHtml(item.audioKey)}">â–¶ å†ç”Ÿ</button>`
        : `<span class="small muted">éŒ²éŸ³ãªã—</span>`;

      div.innerHTML = `
        <div class="row">
          <span class="pill">${ds}</span>
          <span class="pill ok">${escapeHtml(item.tag || "-")}</span>
          <span class="pill">30ç§’:${msToStr(item.ms30)}</span>
          <span class="pill">15ç§’:${msToStr(item.ms15)}</span>
          <span class="pill">è©•ä¾¡:${score}/5</span>
          ${audioBtn}
        </div>
        <div style="margin-top:6px;"><b>ä¸€è¨€ï¼š</b>${escapeHtml(item.oneLine || "")}</div>
        <div class="small muted" style="margin-top:4px;">${escapeHtml(item.prompt || "")}</div>
      `;
      root.appendChild(div);

      const btn = div.querySelector("button[data-audio]");
      if (btn) btn.addEventListener("click", () => playAudio(btn.getAttribute("data-audio"), btn));
    });
  }

  function buildRecord() {
    const now = new Date();
    const date = now.toISOString();
    const p = (promptIndex === -1) ? {tag:"", text:""} : prompts[promptIndex];
    const checks = {
      conclusion: $("chkConclusion").checked,
      reason: $("chkReason").checked,
      example: $("chkExample").checked,
      noFiller: $("chkNoFiller").checked,
      noRepeat: $("chkNoRepeat").checked
    };
    return {
      date,
      tag: p.tag,
      prompt: p.text,
      oneLine: $("oneLine").value.trim(),
      ketsuron: $("ketsuron").value.trim(),
      riyuu: $("riyuu").value.trim(),
      rei: $("rei").value.trim(),
      ms30: state.last30ms,
      ms15: state.last15ms,
      memo: $("memo").value.trim(),
      checks,
      audioKey: state.audioKey || null
    };
  }

  // â˜…é‡è¦ï¼šã“ã‚ŒãŒç„¡ã„ã¨ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§JSãŒæ­»ã¬
  function resetAllButHistory() {
    state.s1 = state.s2 = state.s3 = state.s4 = false;
    state.last30ms = 0; state.last15ms = 0;

    $("oneLine").value = "";
    ["ketsuron","riyuu","rei"].forEach(id => { $(id).value=""; $(id).disabled = true; });

    resetTimer();
    $("beep").disabled = true;
    $("startBtn").disabled = true;
    $("stopBtn").disabled = true;
    $("resetBtn").disabled = true;
    $("s3DoneBtn").disabled = true;
    $("start15Btn").disabled = true;
    $("s4DoneBtn").disabled = true;

    $("s1Badge").className = "pill warn"; $("s1Badge").textContent = "æœªå®Œäº†";
    $("s2Badge").className = "pill warn"; $("s2Badge").textContent = "ãƒ­ãƒƒã‚¯ä¸­";
    $("s3Badge").className = "pill warn"; $("s3Badge").textContent = "ãƒ­ãƒƒã‚¯ä¸­";
    $("s4Badge").className = "pill warn"; $("s4Badge").textContent = "ãƒ­ãƒƒã‚¯ä¸­";

    ["chkConclusion","chkReason","chkExample","chkNoFiller","chkNoRepeat"].forEach(id => $(id).checked=false);
    $("memo").value = "";
    $("saveBtn").disabled = true;
    $("copyBtn").disabled = true;
    $("evalBadge").textContent = "æœªä¿å­˜";
    $("evalBadge").className = "pill warn";

    $("recStartBtn").disabled = true;
    $("recStopBtn").disabled = true;
    $("recClearBtn").disabled = !state.audioKey;
    $("recDot").className = "dot";
    $("recStatus").textContent = "STEP2å®Œäº†å¾Œã«ä½¿ãˆã¾ã™ã€‚";
    $("recPreview").style.display = state.audioKey ? "block" : "none";
    setRecUI(false);

    $("status").textContent = "STEP2å®Œäº†å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚";
  }

  // ---- Events ----
  $("nextPromptBtn").addEventListener("click", () => {
    nextPrompt();
    resetAllButHistory();
  });

  $("s1DoneBtn").addEventListener("click", () => {
    if (promptIndex === -1) nextPrompt();
    const text = $("oneLine").value.trim();
    if (!text) { alert("ä¸€è¨€è¦ç´„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    state.s1 = true;
    $("s1Badge").className = "pill ok";
    $("s1Badge").textContent = "å®Œäº†";
    unlockStep2();
    $("s2Badge").className = "pill warn";
    $("s2Badge").textContent = "æœªå®Œäº†";
  });

  $("s2DoneBtn").addEventListener("click", () => {
    const k = $("ketsuron").value.trim();
    const r = $("riyuu").value.trim();
    const e = $("rei").value.trim();
    if (!k || !r || !e) { alert("çµè«–ãƒ»ç†ç”±ãƒ»ä¾‹ã‚’åŸ‹ã‚ã¦ãã ã•ã„"); return; }
    state.s2 = true;
    $("s2Badge").className = "pill ok";
    $("s2Badge").textContent = "å®Œäº†";
    unlockStep3();
    $("s3Badge").className = "pill warn";
    $("s3Badge").textContent = "æœªå®Œäº†";
  });

  $("startBtn").addEventListener("click", () => startTimer(30));
  $("stopB

