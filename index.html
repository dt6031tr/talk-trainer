<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:16px;line-height:1.5;background:#fafafa}
    h1{font-size:18px;margin:0 0 10px}
    .card{background:#fff;border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 12px;border-radius:12px;border:1px solid #bbb;background:#fff}
    button.primary{border-color:#111}
    button:disabled{opacity:.45}
    input,textarea,select{width:100%;box-sizing:border-box;padding:10px;border-radius:12px;border:1px solid #bbb}
    .pill{padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    .ok{border-color:#1a7f37;color:#1a7f37}
    .warn{border-color:#b45309;color:#b45309}
    .small{font-size:13px;color:#555}
    .timer{font-size:40px;font-variant-numeric:tabular-nums;margin:6px 0}
    .dot{width:10px;height:10px;border-radius:999px;background:#bbb;display:inline-block}
    .dot.rec{background:#d00000;box-shadow:0 0 0 4px rgba(208,0,0,.15)}
    .historyItem{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
    .audioBox{padding:10px;border:1px solid #eee;border-radius:12px;margin-top:10px}
    .hr{height:1px;background:#eee;margin:12px 0}
  </style>
</head>
<body>

<h1>è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆé †ç•ªï¼šä¸€è¨€â†’æ§‹é€ â†’30ç§’â†’15ç§’ï¼‰</h1>

<div class="card">
  <div class="row">
    <span class="pill">ãŠé¡Œ</span>
    <span id="tag" class="pill ok">æœªé¸æŠ</span>
    <button id="nextPromptBtn">ãŠé¡Œã‚’å‡ºã™</button>
  </div>
  <div style="margin-top:10px;">
    <div class="small">ä»Šæ—¥ã®ãŠé¡Œ</div>
    <div id="prompt" style="font-size:16px;font-weight:600;">ã€ŒãŠé¡Œã‚’å‡ºã™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <b>STEP 1ï¼šä¸€è¨€è¦ç´„ï¼ˆ30æ–‡å­—ç›®å®‰ï¼‰</b>
      <div class="small">ä¸»èªï¼‹çµè«–ã€‚ã¾ãšâ€œè¨€ã„åˆ‡ã‚‹â€ã€‚</div>
    </div>
    <span id="s1Badge" class="pill warn">æœªå®Œäº†</span>
  </div>
  <input id="oneLine" placeholder="ä¾‹ï¼šãƒ•ãƒ­ã‚¹ã¯éš£æ¥é¢ã®æ±šã‚Œã‚’è½ã¨ã™ãŸã‚å¿…è¦" maxlength="60">
  <div class="row" style="margin-top:10px;">
    <button class="primary" id="s1DoneBtn">STEP1å®Œäº†</button>
    <span class="small" style="color:#666">ï¼ˆå¤šå°‘ã‚ªãƒ¼ãƒãƒ¼ã¯OKï¼‰</span>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <b>STEP 2ï¼šçµè«–â†’ç†ç”±â†’ä¾‹ï¼ˆç®‡æ¡æ›¸ãã§OKï¼‰</b>
      <div class="small">è©±ã™å‰ã«â€œå‹â€ã‚’ç½®ãã€‚</div>
    </div>
    <span id="s2Badge" class="pill warn">ãƒ­ãƒƒã‚¯ä¸­</span>
  </div>

  <div style="margin-top:10px">
    <div class="small" style="color:#666">çµè«–</div>
    <input id="ketsuron" placeholder="çµè«–" disabled>
    <div class="small" style="color:#666;margin-top:8px">ç†ç”±</div>
    <input id="riyuu" placeholder="ç†ç”±" disabled>
    <div class="small" style="color:#666;margin-top:8px">ä¾‹</div>
    <input id="rei" placeholder="ä¾‹" disabled>
  </div>

  <div class="row" style="margin-top:10px;">
    <button class="primary" id="s2DoneBtn" disabled>STEP2å®Œäº†</button>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <b>STEP 3ï¼š30ç§’ã§è©±ã™ï¼ˆã‚¿ã‚¤ãƒãƒ¼ï¼‰ï¼‹éŒ²éŸ³</b>
      <div class="small">çµè«–â†’ç†ç”±â†’ä¾‹ã§ã€‚</div>
    </div>
    <span id="s3Badge" class="pill warn">ãƒ­ãƒƒã‚¯ä¸­</span>
  </div>

  <div class="row" style="margin-top:8px;">
    <span class="pill">ãƒ“ãƒ¼ãƒ—</span>
    <select id="beep" disabled>
      <option value="on">ON</option>
      <option value="off">OFF</option>
    </select>
  </div>

  <div class="timer" id="timer30">00:30.0</div>

  <div class="row">
    <button class="primary" id="start30Btn" disabled>é–‹å§‹</button>
    <button id="stop30Btn" disabled>åœæ­¢</button>
    <button id="reset30Btn" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="s3DoneBtn" disabled>STEP3å®Œäº†</button>
  </div>

  <div class="audioBox">
    <div class="row">
      <span class="pill">éŒ²éŸ³</span>
      <span id="recDot" class="dot"></span>
      <span id="recStatus" class="small">STEP2å®Œäº†å¾Œã«ä½¿ãˆã¾ã™ã€‚</span>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="primary" id="recStartBtn" disabled>ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
      <button id="recStopBtn" disabled>â¹ éŒ²éŸ³åœæ­¢</button>
      <button id="recClearBtn" disabled>ğŸ—‘ ç ´æ£„</button>
    </div>
    <audio id="recPreview" controls style="width:100%;margin-top:10px;display:none;"></audio>
    <div class="small" style="color:#666;margin-top:8px;">â€»åˆå›ã¯ãƒã‚¤ã‚¯è¨±å¯ãŒå‡ºã¾ã™ã€‚ã€Œè¨±å¯ã€ã—ã¦ãã ã•ã„ã€‚</div>
  </div>

  <div class="small" id="status30" style="margin-top:8px;color:#666">STEP2å®Œäº†å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚</div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <b>STEP 4ï¼š15ç§’ã«å‰Šã‚‹ï¼ˆã‚¿ã‚¤ãƒãƒ¼ï¼‰</b>
      <div class="small">â€œåŠåˆ†ã«ã™ã‚‹â€ãŒç«¯çš„åŒ–ã®æ ¸å¿ƒã€‚</div>
    </div>
    <span id="s4Badge" class="pill warn">ãƒ­ãƒƒã‚¯ä¸­</span>
  </div>

  <div class="timer" id="timer15">00:15.0</div>
  <div class="row">
    <button class="primary" id="start15Btn" disabled>é–‹å§‹</button>
    <button id="stop15Btn" disabled>åœæ­¢</button>
    <button id="reset15Btn" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="s4DoneBtn" disabled>STEP4å®Œäº†</button>
  </div>
  <div class="small" id="status15" style="margin-top:8px;color:#666">STEP3å®Œäº†å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚</div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <b>ä¿å­˜ãƒ»å±¥æ­´</b>
      <div class="small">ä¿å­˜ã™ã‚‹ã¨ç«¯æœ«å†…ã«æ®‹ã‚Šã¾ã™ã€‚</div>
    </div>
    <span id="saveBadge" class="pill warn">æœªä¿å­˜</span>
  </div>

  <div class="hr"></div>

  <div class="row">
    <button class="primary" id="saveBtn" disabled>è¨˜éŒ²ã‚’ä¿å­˜</button>
    <button id="copyBtn" disabled>æ·»å‰Šç”¨ã«ã‚³ãƒ”ãƒ¼</button>
    <button id="clearBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="wipeHistoryBtn">å±¥æ­´å‰Šé™¤</button>
  </div>

  <div id="history" style="margin-top:10px;"></div>
</div>

<script>
const $ = (id) => document.getElementById(id);

// ===== Prompts (random, no immediate repeat) =====
const prompts = [
  { tag:"æ­¯ç§‘ï¼ˆæ‚£è€…èª¬æ˜ï¼‰", text:"ãƒ•ãƒ­ã‚¹ãŒå¿…è¦ãªç†ç”±ã‚’ã€æ‚£è€…ã•ã‚“ã«ã‚ã‹ã‚‹è¨€è‘‰ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"æ­¯ç§‘ï¼ˆåˆè¨ºï¼‰", text:"ã€åˆè¨ºã§ã¯ä»Šæ—¥ã¯æ²»ç™‚ã‚’ã—ãªã„ã€ç†ç”±ã‚’ã€å®‰å¿ƒæ„ŸãŒå‡ºã‚‹ã‚ˆã†ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘", text:"é™¢å†…ã§ã€çµè«–ã‹ã‚‰è©±ã™ã€ãƒ«ãƒ¼ãƒ«ã‚’å°å…¥ã™ã‚‹ç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"çµŒå–¶", text:"æ¤œæŸ»ï¼ˆå†™çœŸãƒ»æ­¯å‘¨æ¤œæŸ»ç­‰ï¼‰ã‚’å¤§äº‹ã«ã™ã‚‹ä¾¡å€¤ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"æ—¥å¸¸", text:"ä»Šæ—¥ã„ã¡ã°ã‚“å¤§äº‹ã ã£ãŸå‡ºæ¥äº‹ã‚’ã€ç«¯çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" },
  { tag:"å­¦ä¼š/ç™ºè¡¨", text:"ã‚ãªãŸã®ç™ºè¡¨ãƒ†ãƒ¼ãƒã®è‡¨åºŠçš„æ„ç¾©ã‚’30ç§’ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚" }
];
let promptIndex = -1;
function pickRandomPromptIndex() {
  if (prompts.length <= 1) return 0;
  let idx = promptIndex;
  while (idx === promptIndex) idx = Math.floor(Math.random() * prompts.length);
  return idx;
}
function nextPrompt() {
  promptIndex = pickRandomPromptIndex();
  $("tag").textContent = prompts[promptIndex].tag;
  $("prompt").textContent = prompts[promptIndex].text;
}

// ===== IndexedDB (audio) =====
const DB_NAME = "talk_trainer_db_v1";
const STORE = "audio";
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function putBlob(key, blob) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put(blob, key);
    tx.oncomplete = () => { db.close(); resolve(); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}
async function getBlob(key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess = () => { const v = req.result; db.close(); resolve(v || null); };
    req.onerror = () => { db.close(); reject(req.error); };
  });
}
async function delBlob(key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).delete(key);
    tx.oncomplete = () => { db.close(); resolve(); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}

// ===== Beep =====
function beep() {
  if ($("beep").value !== "on") return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine"; o.frequency.value = 880;
  g.gain.value = 0.06;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  setTimeout(() => { o.stop(); ctx.close(); }, 180);
}

// ===== Timers =====
function fmt(ms){
  const s = ms/1000;
  const m = Math.floor(s/60);
  const sec = (s - m*60).toFixed(1).padStart(4,"0");
  return String(m).padStart(2,"0")+":"+sec;
}

function makeTimer(viewId, statusId, startBtnId, stopBtnId, resetBtnId, durationSec){
  let raf=null, startAt=null, elapsed=0, durationMs=durationSec*1000;

  function render(){
    const left = Math.max(0, durationMs - elapsed);
    $(viewId).textContent = fmt(left);
  }

  function loop(){
    const now=performance.now();
    elapsed = now - startAt;
    if(elapsed >= durationMs){
      elapsed = durationMs;
      render();
      stop(true);
      return;
    }
    render();
    raf = requestAnimationFrame(loop);
  }

  function start(){
    if(raf) cancelAnimationFrame(raf);
    startAt = performance.now() - elapsed;
    raf = requestAnimationFrame(loop);
    $(startBtnId).disabled = true;
    $(stopBtnId).disabled = false;
    $(statusId).textContent = durationSec + "ç§’ï¼šè©±ã—ã¦ãã ã•ã„ã€‚";
  }

  function stop(auto=false){
    if(raf) cancelAnimationFrame(raf);
    raf=null;
    $(startBtnId).disabled = false;
    $(stopBtnId).disabled = true;
    if(auto){ beep(); $(statusId).textContent = "æ™‚é–“ã§ã™ã€‚"; }
    else { $(statusId).textContent = "åœæ­¢ã—ã¾ã—ãŸã€‚"; }
  }

  function reset(){
    if(raf) cancelAnimationFrame(raf);
    raf=null;
    elapsed=0;
    render();
    $(startBtnId).disabled = false;
    $(stopBtnId).disabled = true;
    $(statusId).textContent = "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚";
  }

  function getElapsed(){ return elapsed; }
  function setEnabled(on){
    $(startBtnId).disabled = !on;
    $(stopBtnId).disabled = true;
    $(resetBtnId).disabled = !on;
  }

  $(startBtnId).addEventListener("click", start);
  $(stopBtnId).addEventListener("click", () => stop(false));
  $(resetBtnId).addEventListener("click", reset);

  // init
  render();
  setEnabled(false);

  return { reset, setEnabled, getElapsed };
}

const timer30 = makeTimer("timer30","status30","start30Btn","stop30Btn","reset30Btn",30);
const timer15 = makeTimer("timer15","status15","start15Btn","stop15Btn","reset15Btn",15);

// ===== Recording =====
let mediaStream=null, recorder=null, chunks=[], previewUrl=null;
let audioKey=null;

function setRecUI(isRec){
  $("recDot").className = "dot" + (isRec ? " rec" : "");
  $("recStartBtn").disabled = isRec || !state.s2;
  $("recStopBtn").disabled = !isRec;
  $("recClearBtn").disabled = isRec ? true : !audioKey;
  $("recStatus").textContent = isRec ? "éŒ²éŸ³ä¸­â€¦" : (audioKey ? "éŒ²éŸ³ã‚ã‚Šï¼ˆä¿å­˜æ¸ˆã¿ï¼‰" : (state.s2 ? "éŒ²éŸ³ã§ãã¾ã™ï¼ˆä»»æ„ï¼‰" : "STEP2å®Œäº†å¾Œã«ä½¿ãˆã¾ã™ã€‚"));
}

async function startRecording(){
  try{
    if(!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks=[];
    recorder = new MediaRecorder(mediaStream);
    recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    recorder.onstop = async () => {
      const blob = new Blob(chunks, {type: recorder.mimeType || "audio/webm"});
      audioKey = "audio_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      await putBlob(audioKey, blob);

      if(previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(blob);
      $("recPreview").src = previewUrl;
      $("recPreview").style.display = "block";

      setRecUI(false);
      renderHistory();
    };
    recorder.start();
    setRecUI(true);
  }catch(err){
    alert("ãƒã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    console.error(err);
  }
}
function stopRecording(){ if(recorder && recorder.state!=="inactive") recorder.stop(); }
async function clearRecording(){
  if(!audioKey) return;
  await delBlob(audioKey);
  audioKey=null;
  if(previewUrl) URL.revokeObjectURL(previewUrl);
  previewUrl=null;
  $("recPreview").removeAttribute("src");
  $("recPreview").style.display="none";
  setRecUI(false);
  renderHistory();
}
$("recStartBtn").addEventListener("click", startRecording);
$("recStopBtn").addEventListener("click", stopRecording);
$("recClearBtn").addEventListener("click", clearRecording);

// ===== History =====
const KEY="talk_trainer_history_v4";
function getHistory(){ try{return JSON.parse(localStorage.getItem(KEY)||"[]");}catch{return [];} }
function setHistory(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

async function playAudio(k, btn){
  try{
    btn.disabled=true;
    const blob=await getBlob(k);
    if(!blob){alert("éŒ²éŸ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return;}
    const url=URL.createObjectURL(blob);
    const a=new Audio(url);
    a.onended=()=>URL.revokeObjectURL(url);
    await a.play();
  }finally{ btn.disabled=false; }
}

function renderHistory(){
  const h=getHistory().slice(0,10);
  const root=$("history");
  root.innerHTML="";
  if(h.length===0){ root.innerHTML = `<div class="small" style="color:#666">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; return; }

  h.forEach(item=>{
    const d=new Date(item.date);
    const div=document.createElement("div");
    div.className="historyItem";
    div.innerHTML = `
      <div class="row">
        <span class="pill">${escapeHtml(d.toLocaleString("ja-JP"))}</span>
        <span class="pill ok">${escapeHtml(item.tag||"-")}</span>
        <span class="pill">30ç§’:${escapeHtml(item.t30||"-")}</span>
        <span class="pill">15ç§’:${escapeHtml(item.t15||"-")}</span>
        ${item.audioKey ? `<button data-a="${escapeHtml(item.audioKey)}">â–¶ å†ç”Ÿ</button>` : `<span class="small" style="color:#666">éŒ²éŸ³ãªã—</span>`}
      </div>
      <div style="margin-top:6px"><b>ä¸€è¨€ï¼š</b>${escapeHtml(item.oneLine||"")}</div>
      <div class="small" style="color:#666">${escapeHtml(item.prompt||"")}</div>
    `;
    root.appendChild(div);
    const btn=div.querySelector("button[data-a]");
    if(btn) btn.addEventListener("click", ()=>playAudio(btn.getAttribute("data-a"), btn));
  });
}

// ===== State / Locks =====
const state = { s1:false, s2:false, s3:false, s4:false, ms30:0, ms15:0 };

function lockAll(){
  // Step2
  ["ketsuron","riyuu","rei"].forEach(id => { $(id).disabled=true; $(id).value=""; });
  $("s2DoneBtn").disabled=true;

  // Step3
  $("beep").disabled=true;
  timer30.setEnabled(false);
  $("s3DoneBtn").disabled=true;

  // Recording
  audioKey=null;
  if(previewUrl) URL.revokeObjectURL(previewUrl);
  previewUrl=null;
  $("recPreview").style.display="none";
  $("recPreview").removeAttribute("src");
  setRecUI(false);

  // Step4
  timer15.setEnabled(false);
  $("s4DoneBtn").disabled=true;

  // Save
  $("saveBtn").disabled=true;
  $("copyBtn").disabled=true;

  // badges
  $("s1Badge").className="pill warn"; $("s1Badge").textContent="æœªå®Œäº†";
  $("s2Badge").className="pill warn"; $("s2Badge").textContent="ãƒ­ãƒƒã‚¯ä¸­";
  $("s3Badge").className="pill warn"; $("s3Badge").textContent="ãƒ­ãƒƒã‚¯ä¸­";
  $("s4Badge").className="pill warn"; $("s4Badge").textContent="ãƒ­ãƒƒã‚¯ä¸­";
  $("saveBadge").className="pill warn"; $("saveBadge").textContent="æœªä¿å­˜";

  // status
  $("status30").textContent="STEP2å®Œäº†å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚";
  $("status15").textContent="STEP3å®Œäº†å¾Œã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚";
}

function resetAllButHistory(){
  state.s1=state.s2=state.s3=state.s4=false;
  state.ms30=0; state.ms15=0;
  $("oneLine").value="";
  timer30.reset();
  timer15.reset();
  lockAll();
}

function unlockStep2(){
  ["ketsuron","riyuu","rei"].forEach(id => $(id).disabled=false);
  $("s2DoneBtn").disabled=false;
  $("s2Badge").textContent="æœªå®Œäº†";
}
function unlockStep3(){
  $("beep").disabled=false;
  timer30.setEnabled(true);
  $("s3DoneBtn").disabled=false;
  $("s3Badge").textContent="æœªå®Œäº†";
  setRecUI(false);
  $("recStartBtn").disabled=false;
  $("recStatus").textContent="éŒ²éŸ³ã§ãã¾ã™ï¼ˆä»»æ„ï¼‰ã€‚";
  $("status30").textContent="30ç§’ã§è©±ã—ã¦ãã ã•ã„ï¼ˆçµè«–â†’ç†ç”±â†’ä¾‹ï¼‰ã€‚";
}
function unlockStep4(){
  timer15.setEnabled(true);
  $("s4DoneBtn").disabled=false;
  $("s4Badge").textContent="æœªå®Œäº†";
  $("status15").textContent="15ç§’ã§å‰Šã£ã¦è©±ã—ã¦ãã ã•ã„ã€‚";
}
function unlockSave(){
  $("saveBtn").disabled=false;
  $("copyBtn").disabled=false;
  $("saveBadge").className="pill ok";
  $("saveBadge").textContent="ä¿å­˜ã§ãã¾ã™";
}

// ===== Events =====
$("nextPromptBtn").addEventListener("click", () => {
  nextPrompt();
  resetAllButHistory();
});

$("s1DoneBtn").addEventListener("click", () => {
  if(promptIndex===-1) nextPrompt();
  const t=$("oneLine").value.trim();
  if(!t){ alert("ä¸€è¨€è¦ç´„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  state.s1=true;
  $("s1Badge").className="pill ok"; $("s1Badge").textContent="å®Œäº†";
  $("s2Badge").className="pill warn"; $("s2Badge").textContent="æœªå®Œäº†";
  unlockStep2();
});

$("s2DoneBtn").addEventListener("click", () => {
  const k=$("ketsuron").value.trim(), r=$("riyuu").value.trim(), e=$("rei").value.trim();
  if(!k||!r||!e){ alert("çµè«–ãƒ»ç†ç”±ãƒ»ä¾‹ã‚’åŸ‹ã‚ã¦ãã ã•ã„"); return; }
  state.s2=true;
  $("s2Badge").className="pill ok"; $("s2Badge").textContent="å®Œäº†";
  $("s3Badge").className="pill warn"; $("s3Badge").textContent="æœªå®Œäº†";
  unlockStep3();
});

$("s3DoneBtn").addEventListener("click", () => {
  state.s3=true;
  state.ms30 = timer30.getElapsed();
  $("s3Badge").className="pill ok"; $("s3Badge").textContent="å®Œäº†";
  $("s4Badge").className="pill warn"; $("s4Badge").textContent="æœªå®Œäº†";
  unlockStep4();
  timer30.reset();
});

$("s4DoneBtn").addEventListener("click", () => {
  state.s4=true;
  state.ms15 = timer15.getElapsed();
  $("s4Badge").className="pill ok"; $("s4Badge").textContent="å®Œäº†";
  unlockSave();
  timer15.reset();
});

function buildRecord(){
  const p=(promptIndex===-1)?{tag:"",text:""}:prompts[promptIndex];
  const t30 = state.ms30 ? (state.ms30/1000).toFixed(1)+"s" : "-";
  const t15 = state.ms15 ? (state.ms15/1000).toFixed(1)+"s" : "-";
  return {
    date: new Date().toISOString(),
    tag: p.tag,
    prompt: p.text,
    oneLine: $("oneLine").value.trim(),
    ketsuron: $("ketsuron").value.trim(),
    riyuu: $("riyuu").value.trim(),
    rei: $("rei").value.trim(),
    t30, t15,
    audioKey: audioKey || null
  };
}

$("saveBtn").addEventListener("click", () => {
  if(!state.s4){ alert("STEP4ã¾ã§å®Œäº†ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„"); return; }
  const rec=buildRecord();
  const h=getHistory();
  h.unshift(rec);
  setHistory(h);
  renderHistory();
  $("saveBadge").className="pill ok";
  $("saveBadge").textContent="ä¿å­˜æ¸ˆã¿";
});

$("copyBtn").addEventListener("click", async () => {
  const rec=buildRecord();
  const d=new Date(rec.date).toLocaleString("ja-JP");
  const text =
`ã€è©±ã—æ–¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã€‘
æ—¥æ™‚ï¼š${d}
ãŠé¡Œï¼š${rec.tag} / ${rec.prompt}

STEP1ï¼ˆä¸€è¨€ï¼‰ï¼š
${rec.oneLine}

STEP2ï¼ˆçµè«–â†’ç†ç”±â†’ä¾‹ï¼‰ï¼š
çµè«–ï¼š${rec.ketsuron}
ç†ç”±ï¼š${rec.riyuu}
ä¾‹ã€€ï¼š${rec.rei}

ã‚¿ã‚¤ãƒ ï¼š
30ç§’ï¼š${rec.t30}
15ç§’ï¼š${rec.t15}

éŒ²éŸ³ï¼š${rec.audioKey ? "ã‚ã‚Šï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰" : "ãªã—"}
`;
  try{
    await navigator.clipboard.writeText(text);
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ã“ã“ã«è²¼ã‚Œã°æ·»å‰Šã§ãã¾ã™ã€‚");
  }catch{
    alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
});

$("clearBtn").addEventListener("click", resetAllButHistory);

$("wipeHistoryBtn").addEventListener("click", () => {
  if(!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  setHistory([]);
  renderHistory();
});

// init
timer30.reset(); timer15.reset();
renderHistory();
resetAllButHistory();
</script>

</body>
</html>
